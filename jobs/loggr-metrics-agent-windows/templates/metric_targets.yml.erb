<%
scrape_configs = [
{
  "job_name" => "metrics_agent_exporter_#{spec.name}",
  "scheme" => "https",
  "tls_config" => {
    "server_name" => "metrics_agent",
  },
  "dns_sd_configs" => [
    {
      "names" => ["q-s0.#{spec.name}.*.*.#{spec.dns_domain_name}"],
      "type" => "A",
      "port" => p('metrics_exporter_port'),
    },
  ]
},
{
  "job_name" => "metrics_agent_#{spec.name}",
  "scheme" => "https",
  "tls_config" => {
    "server_name" => "metrics_agent",
  },
  "dns_sd_configs" => [
    {
      "names" => ["q-s0.#{spec.name}.*.*.#{spec.dns_domain_name}"],
      "type" => "A",
      "port" => p('metrics.port'),
    },
  ],
  "relabel_configs" => [
    {
      "source_labels"=> ['__address__'], # always there (added by Prometheus)
      "target_label" => 'source_id',
      "replacement" => 'metrics_agent'
    },
    {
      "source_labels"=> ['__address__'], # always there (added by Prometheus)
      "target_label" => 'origin',
      "replacement" => 'loggregator_metrics_agent'
    }
  ]
}
]
%>

<%= YAML.dump({"scrape_configs" => scrape_configs}) %>