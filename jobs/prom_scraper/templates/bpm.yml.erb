<%
  loggregator_agent_port = nil

  if_p('loggregator_agent.grpc_port') { |agent_port|
    loggregator_agent_port = agent_port
  }.else_if_link("loggregator") { |loggregator|
    loggregator_agent_port = loggregator.p("metron_endpoint.grpc_port")
  }

  cert_dir = "/var/vcap/jobs/prom_scraper/config/certs"

  process = {
    "name" => "prom_scraper",
    "executable" => "/var/vcap/packages/prom_scraper/prom-scraper",
    "unsafe" => {
      "unrestricted_volumes" => [
        { "path" => "/var/vcap/jobs", "mount_only" => true },
        { "path" => "/var/vcap/data/jobs", "mount_only" => true },
      ],
    },
    "env" => {
      "LOGGREGATOR_AGENT_ADDR" => "localhost:#{loggregator_agent_port}",
      "CA_CERT_PATH" => "#{cert_dir}/loggregator_ca.crt",
      "CLIENT_CERT_PATH" => "#{cert_dir}/loggregator_agent.crt",
      "CLIENT_KEY_PATH" => "#{cert_dir}/loggregator_agent.key",
      "CONFIG_GLOBS" => "#{p('config_globs').join(',')}",
      "SCRAPE_INTERVAL" => "#{p('scrape_interval')}",
      "DEFAULT_SOURCE_ID" => "#{spec.name}",
      "SKIP_SSL_VALIDATION" => "#{p('skip_ssl_validation')}",
    }
  }

  if_p('scrape.tls.ca_cert') {
    process["env"]["SCRAPE_CA_CERT_PATH"] = "#{cert_dir}/scrape_ca.crt"
    process["env"]["SCRAPE_CERT_PATH"] = "#{cert_dir}/scrape.crt"
    process["env"]["SCRAPE_KEY_PATH"] = "#{cert_dir}/scrape.key"
    process["env"]["SCRAPE_COMMON_NAME"] = "#{p('scrape.tls.cn', "")}"
  }

  bpm = {"processes" => [process] }
%>

<%= YAML.dump(bpm) %>
